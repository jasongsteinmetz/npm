services:
  npmplus:
    container_name: npmplus
    image: docker.io/zoeyvid/npmplus:latest
    restart: always
    deploy:
      resources:
        limits:
          memory: 4G
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    volumes:
      - /var/lib/docker_data/npmplus/data:/data
      - /var/lib/docker_data/npmplus/certs:/etc/letsencrypt
      - /var/lib/docker_data/geoip:/opt/npmplus/goaccess/geoip
    environment:
      - TZ=America/New_York
      - ACME_EMAIL=admin@streametz.com
      - GOA=true
    ports:
      - '80:80'
      - '81:81'
      - '443:443'
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - homepage.group=Network
      - homepage.name=NPMPlus
      - homepage.icon=nginx-proxy-manager.png
      - homepage.href=http://freckles:81
      # WIDGET
      - homepage.widget.type=npm
      - homepage.widget.url=http://npmplus:81
      - homepage.widget.username=readonly@streametz.com
      - homepage.widget.password=${NPM_PASSWORD}

  crowdsec:
    container_name: crowdsec
    image: docker.io/crowdsecurity/crowdsec:latest
    restart: always
    deploy:
      resources:
        limits:
          memory: 4G
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    volumes:
      - /var/lib/docker_data/crowdsec/config:/etc/crowdsec
      - /var/lib/docker_data/crowdsec/data:/var/lib/crowdsec/data
      - /var/lib/docker_data/geoip:/var/lib/crowdsec/data/geoip
      - /var/lib/docker_data/npmplus/data/nginx:/opt/npmplus/nginx:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - TZ=America/New_York
      - USE_WAL=true
      - COLLECTIONS=${CROWDSEC_COLLECTIONS}
    healthcheck:
      test: ["CMD", "cscli", "lapi", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - homepage.group=Network
      - homepage.name=CrowdSec
      - homepage.icon=crowdsec.png
      # WIDGET CONFIG
      - homepage.widget.type=crowdsec
      - homepage.widget.url=http://crowdsec:8080
      - homepage.widget.username=${CROWDSEC_USER}
      - homepage.widget.password=${CROWDSEC_PASS}

  cloudflare-ddns:
    container_name: cloudflare-ddns
    image: timothyjmiller/cloudflare-ddns:latest
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - PUID=1000
      - PGID=1000
    volumes:
      - /var/lib/docker_data/cloudflare_ddns/config.json:/config.json
    restart: unless-stopped

  geoipupdate:
    image: ghcr.io/maxmind/geoipupdate:v7.0
    container_name: geoipupdate
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - GEOIPUPDATE_ACCOUNT_ID=${GEOIP_ACCOUNT_ID}
      - GEOIPUPDATE_LICENSE_KEY=${GEOIP_LICENSE_KEY}
      - GEOIPUPDATE_EDITION_IDS=GeoLite2-City GeoLite2-ASN GeoLite2-Country
      - GEOIPUPDATE_FREQUENCY=24
      - TZ=America/New_York
    volumes:
      - /var/lib/docker_data/geoip:/usr/share/GeoIP

networks:
  default:
    name: proxy
    external: true
